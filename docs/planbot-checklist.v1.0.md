# 一、全局参数（锁定）

* 默认时区：`Asia/Shanghai`
* 晚间例行时间（日终核对 + 新计划征集）：**22:00**
* 早间清单时间（可关闭）：**08:30**
* 周总结：**关闭**
* 输入语言：中文优先；任务内容保留原文
* 运行模式：NAS + Docker，长轮询优先；DB 本地持久化

---

# 二、核心交互稿（逐屏文案与按钮，按一天时间轴）

## 2.1 首次使用 `/start`

* 机器人消息：

  ```
  ✅ 已就绪！
  当前时区：Asia/Shanghai
  晚间例行时间：22:00
  早间清单时间：08:30

  常用指令：
  /add 录入计划（多行=多任务）
  /today 查看今日清单
  /week 查看未来 7 天
  /setevening HH:MM 设置晚间时间
  /setmorning HH:MM 设置早间时间（08:30 为默认，可关闭）
  /timezone <IANA 名称> 设置时区（如 Asia/Shanghai）
  ```
* 后端动作：为该用户注册**两个每日日程**（22:00、08:30），写入 DB。

## 2.2 每日晚间 22:00 —— 日终核对（当日到期）

* 机器人消息（若有当日到期条目）：

  ```
  🧾 日终核对（今天应完成）：
  • #12 备份 NAS 配置
  • #13 采购硬盘托架
  ```
* 每条任务紧随一组按钮（**一条任务一组三键**）：

  * `✅ 完成`
  * `⏳ 未完成`
  * `🗑 取消`
* 点击「⏳ 未完成」后，针对该任务**立即替换为**：

  * `顺延 +1 天`
  * `顺延 +2 天`
* 分页策略：**每条消息最多 8–10 项**，多则分多条消息依次推送。

## 2.3 晚间 22:00 —— 新计划征集（当晚只问 1 次）

* 机器人消息：

  ```
  要不要录入「明天 + 一周内」的新计划？
  ```
* 按钮：

  * `现在录入` → 进入“一次性输入模式”
  * `稍后再说` → 当晚不再询问
* 进入“一次性输入模式”后的提示：

  ```
  请发送多行文本，每行=1 个任务。
  行内可写日期：今天/明天/后天/周三/下周一/11-15/2025-11-15/+2d/+1w。
  未写日期默认归档到「明天」。
  ```
* 成功入库后的回执（示例）：

  ```
  已创建 5 项：
  • 明天 买菜  →  2025-11-08
  • 周五 下午 3 点开会  →  2025-11-14
  • +2d 跑 RAID 校验  →  2025-11-10
  • 下周一 客户回访  →  2025-11-10
  • 11-15 NAS 固件更新  →  2025-11-15
  ```

## 2.4 每日早间 08:30 —— 今日清单（可关）

* 若有当日 `pending/missed`：

  ```
  🌅 今日待办：
  • #21 备份 NAS 配置
  • #22 采购硬盘托架
  ```
* 若无：**不发**（默认静默，避免打扰；如需提示，可改成“今天没有待办 ✅”）

## 2.5 随时可用命令

* `/add`：进入一次性输入模式（同 2.3）
* `/today`：输出当日 `pending/missed` 列表（不含 done/canceled）
* `/week`：输出从今日起 7 天内的任务（按日聚合）
* `/setevening 21:30`：更新晚间时间并**立刻重建调度**
* `/setmorning 08:00` 或 `/setmorning off`：设时间或关闭早间清单
* `/timezone Asia/Shanghai`：更新时区并**立刻重建调度**

---

# 三、日期解析规范（确定性规则）

* **默认日期**：行内未出现任何可识别日期 → 归档到「明天」。
* **中文关键词**：今天 / 明天 / 后天。
* **周标识**：周一…周日 / 星期一…星期日 → 解释为**下一个**对应星期几（不含今天）。
* **“下周 X”**：落到下一周的对应星期几（相对当前周）。
* **显式日期**：`YYYY-MM-DD`、`MM-DD`、`MM/DD`、`MM.DD`（`MM-DD` 默认当年）。
* **偏移**：`+Nd`（天）、`+Nw`（周）。
* **优先级**：显式日期 > 偏移 > “下周 X” > “周 X” > 今天/明天/后天 > 默认明天。
* **时区基准**：一律按**用户 IANA 时区**计算“今天/明天”等相对日期（默认 East 8）。

---

# 四、状态机（任务生命周期）

* 状态：`pending → (done | canceled | missed)`

  * `pending`：未完成、未取消；到期当晚参与核对。
  * `done`：完成（记录完成时间）。
  * `canceled`：取消（记录取消时间）。
  * `missed`：过期未处理（展示时与 `pending` 一并核对）。
* 事件：

  * 点「✅ 完成」→ `done`
  * 点「🗑 取消」→ `canceled`
  * 点「⏳ 未完成」→ 弹出顺延快捷键；选择 `+1d/+2d` → `due_date` 增加并回到 `pending`
* 过期策略：到期未处理的 `pending` 在次日仍会被列出（可标记为 `missed`，也可保持 `pending` 与文案提示“昨日未清”）。

---

# 五、数据结构（字段级定义）

**users**

* `id`（PK）
* `chat_id`（唯一）
* `tz`（默认 `Asia/Shanghai`）
* `evening_hour`、`evening_min`（默认 `22:00`）
* `morning_hour`、`morning_min`（默认 `08:30`；关闭时可存 `NULL` 或 `-1`）
* `awaiting_plans`（0/1，一次性输入模式开关）
* 索引：`chat_id` 唯一

**tasks**

* `id`（PK）
* `user_id`（FK→users.id）
* `content`（文本，原文）
* `due_date`（`YYYY-MM-DD`）
* `status`（`pending/done/canceled/missed`）
* `created_at`、`updated_at`（ISO8601）
* `completed_at`（可空）
* `canceled_at`（可空）
* 索引：`(user_id, due_date)`、`(user_id, status, due_date)`

**可选：callbacks（去重/审计）**

* `callback_id`（PK）
* `task_id`、`action`、`processed_at`

---

# 六、调度与恢复（Job 规则）

* 为每个用户注册两条每日任务：**22:00 晚间例行**、**08:30 早间清单**（早间可关闭）。
* 用户修改 `/setevening`、`/setmorning`、`/timezone` 后：**立即取消旧 Job 并重建**。
* 进程启动时：扫描 `users`，为**全部用户重建** Job；若错过了当晚例行，可启动后补发「🧾 日终核对（补发）」一次。
* 夏令时与日期进位：一律使用用户的 IANA 时区来计算“今天/明天”。

---

# 七、按钮协议（callback data 的**确定例表**）

> 避免抽象占位描述，下列均给出**真实示例**；你的实现可按相同编码规则拼接。

* 完成：`t:12:done`
* 未完成（弹出顺延）：`t:13:un`
* 取消：`t:14:cancel`
* 顺延 +1 天：`t:13:p:1`
* 顺延 +2 天：`t:13:p:2`
* 新计划征集 - 现在录入：`new:add`
* 新计划征集 - 稍后再说：`new:skip`

> 约束：单个 `callback_data` 长度 ≤ 64 字节；ID 使用整数；不含空格与中文。

---

# 八、异常与边界处理（必须兜底）

* **输入截断**：一次性输入模式每次最多接收 **100 行**；超过部分忽略并在回执中提示“已截断到 100 条”。
* **超长文本**：单行超过 512 字符则截断为前 512 字符并提示。
* **同日重复**：同一 `user_id + due_date + content` 若完全相同，可追加“(2)”后缀或合并计数（任选其一，需固定策略）。
* **按钮重复点击**：同一任务同一动作的重复点击 → 返回“该任务已处理”，不重复变更状态。
* **速率限制**：遇 429，遵循 `retry_after`；晚间核对分批发（每批 8–10 项）并在批间延迟 1–2 秒。
* **停机漏发**：服务恢复后，遇到“昨天到期且未处理”的任务，在下一次 22:00 一并列出，文案增加“（含昨日未清）”。
* **关闭早间清单**：`/setmorning off` 后立即取消对应 Job。再次设置具体时间即恢复。
* **时区非法**：`/timezone` 输入非法 IANA 名称时，直接回复“无效时区名，请使用 IANA 名称，如 Asia/Shanghai”。

---

# 九、可观测性与备份

* **日志**：INFO 级别；不打印任务全文到日志，仅打印任务 ID 和操作；可用 DEBUG 临时开详单。
* **健康检查**：启动成功打印“scheduler ready”；每次 Job 触发打印用户 chat_id 与执行结果计数。
* **DB 备份**：每日一次对 SQLite 文件做快照（冷备），保留 30 天；提供“手工恢复”流程文档。

---

# 十、验收清单（Definition of Done）

* [ ] `/start` 初始化成功；重启后 Job 自动恢复
* [ ] 晚间 22:00 推送核对，**每条任务**均有三键并可顺延
* [ ] 晚间 22:00 推送“新计划征集”，`现在录入/稍后再说` 正常
* [ ] 一次性输入模式：多行→多任务，回执中**逐条显示解析后的日期**
* [ ] `/today`、`/week` 输出正确，且状态实时同步
* [ ] `/setevening`、`/setmorning`、`/timezone` 生效后**立即重建 Job**
* [ ] 429 限流时无崩溃，分批发送可用
* [ ] 停机跨过晚间例行后，恢复时能在次日晚间补列未清项
* [ ] 关闭早间清单后 08:30 不再推送；恢复后正常
* [ ] 数据备份与恢复演练通过

---

# 十一、功能测试用例（覆盖主路径与边界）

1. **解析正确性**

   * `买菜` → 次日日期
   * `周五 下午开会` → 下一个周五日期
   * `+2d RAID 校验` → 两天后
   * `下周一 客户回访` → 下周一
   * `11-15 固件更新` → 当年 11-15
2. **长输入**

   * 一次发送 120 行 → 入库 100，回执提示截断
3. **状态机幂等**

   * 同一任务重复点“✅ 完成” → 第二次返回“该任务已处理”
4. **顺延效果**

   * 点“⏳ 未完成”→“顺延 +1 天”后，在 `/week` 中日期+1
5. **时区正确性**

   * 保持 `Asia/Shanghai`；将本地时间改到夏令时切换日附近进行回归
6. **停机与恢复**

   * 停机跨过 22:00；重启后到次日 22:00 能看到“含昨日未清”
7. **关闭早间清单**

   * `/setmorning off` 后，第二天 08:30 不应推送；再 `/setmorning 08:30` 恢复
8. **限流与分页**

   * 构造 30 条当日任务 → 晚间分 3–4 条消息分页发出，按钮可点

---

# 十二、落地实施步骤（不含代码，操作要点）

1. 在 NAS 创建项目目录并准备持久化目录（如 `./data`）。
2. 以环境变量方式提供：

   * `BOT_TOKEN`（Telegram 机器人 Token）
   * `DB_PATH=/app/data/bot.db`
   * `DEFAULT_TZ=Asia/Shanghai`
   * `DEFAULT_EVENING=22:00`
   * `DEFAULT_MORNING=08:30`
3. Docker 启动策略：`restart=unless-stopped`；挂载卷 `./data:/app/data`。
4. 首次启动后，用你的账号向 Bot 发送 `/start`；然后根据需要执行：

   * `/setevening 22:00`（若非默认可调整）
   * `/setmorning 08:30` 或 `/setmorning off`
   * `/timezone Asia/Shanghai`（如需显式设置）

---

# 十三、产品决策固定项（避免反复讨论）

* 未标日期 → 默认“明天”（东八区本地日历）
* 晚间只询问一次是否新增计划，被点“稍后再说”当晚不再打扰
* 顺延快捷键只提供 `+1d/+2d`（首版）；后续再扩展“选择具体日期”
* `/week` 展示 `pending/missed/done(当周)/canceled(当周)` 可配置，**默认隐藏 done/canceled**
* 每条消息最多 8–10 项，避免按钮拥挤与阅读疲劳

---

## Answering example

**场景：2025-11-08（周六），Asia/Shanghai；当晚 22:00**

**22:00 日终核对**

> 🧾 日终核对（今天应完成）：
> • #12 备份 NAS 配置
> • #13 采购硬盘托架
> （每条任务各自有：✅ 完成 / ⏳ 未完成 / 🗑 取消）

**点击 #12 → ✅ 完成**

> 已标记完成。

**点击 #13 → ⏳ 未完成**

> 请选择顺延天数：
> [顺延 +1 天] [顺延 +2 天]

**选择「顺延 +1 天」**

> 已顺延 1 天（新到期日：2025-11-09）。

**随后 22:00 新计划征集**

> 要不要录入「明天 + 一周内」的新计划？
> [现在录入] [稍后再说]

**选择「现在录入」并发送多行**

```
明天 买菜
周五 下午 3 点开会
+2d 跑 RAID 校验
下周一 客户回访
11-15 NAS 固件更新
```

**机器人回执**

> 已创建 5 项：
> • 明天 买菜  →  2025-11-09
> • 周五 下午 3 点开会  →  2025-11-14
> • +2d 跑 RAID 校验  →  2025-11-10
> • 下周一 客户回访  →  2025-11-10
> • 11-15 NAS 固件更新  →  2025-11-15

---

以上就是“**无代码版、可直接落地**”的开发清单。你按本清单实现，即可得到与你设定完全一致的 Telegram 计划机器人。
