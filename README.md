# Telegram è®¡åˆ’æé†’æœºå™¨äºº

åŸºäº Telegram Bot çš„ä¸ªäººä»»åŠ¡è®¡åˆ’ç®¡ç†å·¥å…·ï¼Œä¸¥æ ¼æŒ‰ç…§ `docs/planbot-checklist.v1.0.md` è§„èŒƒå®ç°ã€‚

## åŠŸèƒ½ç‰¹æ€§

- âœ… **æ™ºèƒ½æ—¥æœŸè§£æ**ï¼šæ”¯æŒå¤šç§ä¸­æ–‡æ—¥æœŸæ ¼å¼ï¼ˆä»Šå¤©/æ˜å¤©/åå¤©/å‘¨X/ä¸‹å‘¨X/MM-DD/+Ndç­‰ï¼‰
- ğŸ“… **å®šæ—¶æé†’**ï¼šæ™šé—´ä¾‹è¡Œæ ¸å¯¹ï¼ˆ22:00ï¼‰+ æ—©é—´æ¸…å•ï¼ˆ08:30ï¼‰
- ğŸ”˜ **äº¤äº’å¼æ“ä½œ**ï¼šå®Œæˆ/å–æ¶ˆ/é¡ºå»¶ä»»åŠ¡ï¼Œæ”¯æŒæŒ‰é’®ç‚¹å‡»
- ğŸŒ **å¤šæ—¶åŒºæ”¯æŒ**ï¼šè‡ªåŠ¨é€‚é…ç”¨æˆ·æ—¶åŒºï¼Œç²¾ç¡®è®¡ç®—"ä»Šå¤©/æ˜å¤©"
- ğŸ’¾ **æ•°æ®æŒä¹…åŒ–**ï¼šSQLite æœ¬åœ°å­˜å‚¨ï¼Œæ”¯æŒ Docker å·æŒ‚è½½
- ğŸ”„ **åœæœºæ¢å¤**ï¼šé‡å¯åè‡ªåŠ¨è¡¥å‘æ˜¨æ—¥æœªæ¸…ä»»åŠ¡

## å¿«é€Ÿå¼€å§‹

### 1. å‡†å¤‡å·¥ä½œ

#### 1.1 åˆ›å»º Telegram Bot

1. åœ¨ Telegram ä¸­æœç´¢ [@BotFather](https://t.me/BotFather)
2. å‘é€ `/newbot` åˆ›å»ºæ–°æœºå™¨äºº
3. æŒ‰æç¤ºè®¾ç½®åç§°å’Œç”¨æˆ·å
4. ä¿å­˜ç”Ÿæˆçš„ **Bot Token**ï¼ˆæ ¼å¼ï¼š`123456789:ABCdefGHIjklMNOpqrsTUVwxyz`ï¼‰

#### 1.2 å…‹éš†é¡¹ç›®

```bash
git clone <repository-url>
cd Telegram_Plan_bot
```

### 2. é…ç½®

#### 2.1 åˆ›å»ºé…ç½®æ–‡ä»¶

```bash
cp config.example.json config.json
```

#### 2.2 ç¼–è¾‘ `config.json`

```json
{
  "bot": {
    "token": "YOUR_BOT_TOKEN_HERE"  // æ›¿æ¢ä¸ºä½ çš„ Bot Token
  },
  "database": {
    "path": "data/bot.db"
  },
  "defaults": {
    "timezone": "Asia/Shanghai",
    "evening_hour": 22,
    "evening_minute": 0,
    "morning_hour": 8,
    "morning_minute": 30
  },
  "logging": {
    "level": "INFO",
    "file": "data/bot.log"
  }
}
```

### 3. éƒ¨ç½²æ–¹å¼

#### æ–¹å¼ä¸€ï¼šDocker Composeï¼ˆæ¨èï¼‰

```bash
# æ„å»ºå¹¶å¯åŠ¨
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f

# åœæ­¢
docker-compose down
```

#### æ–¹å¼äºŒï¼šDocker

```bash
# æ„å»ºé•œåƒ
docker build -t telegram-planbot .

# è¿è¡Œå®¹å™¨
docker run -d \
  --name telegram-planbot \
  --restart unless-stopped \
  -v $(pwd)/data:/app/data \
  -v $(pwd)/config.json:/app/config.json:ro \
  telegram-planbot

# æŸ¥çœ‹æ—¥å¿—
docker logs -f telegram-planbot
```

#### æ–¹å¼ä¸‰ï¼šæœ¬åœ°è¿è¡Œ

```bash
# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# è¿è¡Œ
python main.py
```

### 4. é¦–æ¬¡ä½¿ç”¨

1. åœ¨ Telegram ä¸­æœç´¢ä½ çš„æœºå™¨äºº
2. å‘é€ `/start` åˆå§‹åŒ–
3. å¼€å§‹ä½¿ç”¨ï¼

## ä½¿ç”¨æŒ‡å—

### å‘½ä»¤åˆ—è¡¨

| å‘½ä»¤ | åŠŸèƒ½ | ç¤ºä¾‹ |
|------|------|------|
| `/start` | åˆå§‹åŒ–æœºå™¨äºº | `/start` |
| `/add` | å½•å…¥è®¡åˆ’ï¼ˆå¤šè¡Œ=å¤šä»»åŠ¡ï¼‰ | `/add` |
| `/today` | æŸ¥çœ‹ä»Šæ—¥æ¸…å• | `/today` |
| `/week` | æŸ¥çœ‹æœªæ¥ 7 å¤© | `/week` |
| `/setevening HH:MM` | è®¾ç½®æ™šé—´æ—¶é—´ | `/setevening 22:00` |
| `/setmorning HH:MM` | è®¾ç½®æ—©é—´æ—¶é—´ | `/setmorning 08:30` |
| `/setmorning off` | å…³é—­æ—©é—´æ¸…å• | `/setmorning off` |
| `/timezone <IANA>` | è®¾ç½®æ—¶åŒº | `/timezone Asia/Shanghai` |

### æ—¥æœŸæ ¼å¼æ”¯æŒ

#### ä¸­æ–‡å…³é”®è¯
- **ä»Šå¤©/æ˜å¤©/åå¤©**ï¼š`ä»Šå¤©ä¹°èœ`ã€`æ˜å¤©å¼€ä¼š`
- **å‘¨X**ï¼š`å‘¨äº”ä¸‹åˆå¼€ä¼š`ï¼ˆä¸‹ä¸€ä¸ªå‘¨äº”ï¼Œä¸å«ä»Šå¤©ï¼‰
- **ä¸‹å‘¨X**ï¼š`ä¸‹å‘¨ä¸€å®¢æˆ·å›è®¿`ï¼ˆä¸‹å‘¨å¯¹åº”æ˜ŸæœŸå‡ ï¼‰

#### æ˜¾å¼æ—¥æœŸ
- **YYYY-MM-DD**ï¼š`2025-11-15 å›ºä»¶æ›´æ–°`
- **MM-DD**ï¼š`11-15 å›ºä»¶æ›´æ–°`ï¼ˆé»˜è®¤å½“å¹´ï¼‰
- **MM/DD**ï¼š`11/15 å›ºä»¶æ›´æ–°`
- **MM.DD**ï¼š`11.15 å›ºä»¶æ›´æ–°`

#### åç§»é‡
- **+Nd**ï¼š`+2d RAID æ ¡éªŒ`ï¼ˆ2å¤©åï¼‰
- **+Nw**ï¼š`+1w æœˆåº¦æ€»ç»“`ï¼ˆ1å‘¨åï¼‰

#### é»˜è®¤è¡Œä¸º
- **æœªæŒ‡å®šæ—¥æœŸ**ï¼šé»˜è®¤å½’æ¡£åˆ°ã€Œæ˜å¤©ã€

### æ—¥å¸¸æµç¨‹

#### æ™šé—´ä¾‹è¡Œï¼ˆ22:00ï¼‰

1. **æ—¥ç»ˆæ ¸å¯¹**ï¼šæ¨é€å½“æ—¥åˆ°æœŸä»»åŠ¡
   - æ¯ä¸ªä»»åŠ¡æœ‰ä¸‰ä¸ªæŒ‰é’®ï¼š`âœ… å®Œæˆ` / `â³ æœªå®Œæˆ` / `ğŸ—‘ å–æ¶ˆ`
   - ç‚¹å‡»ã€Œâ³ æœªå®Œæˆã€åå¯é€‰æ‹©é¡ºå»¶ï¼š`+1 å¤©` / `+2 å¤©`

2. **æ–°è®¡åˆ’å¾é›†**ï¼šè¯¢é—®æ˜¯å¦å½•å…¥æ–°è®¡åˆ’
   - `ç°åœ¨å½•å…¥`ï¼šè¿›å…¥ä¸€æ¬¡æ€§è¾“å…¥æ¨¡å¼
   - `ç¨åå†è¯´`ï¼šå½“æ™šä¸å†è¯¢é—®

#### æ—©é—´æ¸…å•ï¼ˆ08:30ï¼‰

- æ¨é€å½“æ—¥å¾…åŠä»»åŠ¡
- è‹¥æ— ä»»åŠ¡åˆ™ä¸å‘é€ï¼ˆé™é»˜ï¼‰

#### éšæ—¶å½•å…¥

å‘é€ `/add` è¿›å…¥ä¸€æ¬¡æ€§è¾“å…¥æ¨¡å¼ï¼Œæ¯è¡Œä¸€ä¸ªä»»åŠ¡ï¼š

```
æ˜å¤© ä¹°èœ
å‘¨äº” ä¸‹åˆ 3 ç‚¹å¼€ä¼š
+2d è·‘ RAID æ ¡éªŒ
ä¸‹å‘¨ä¸€ å®¢æˆ·å›è®¿
11-15 NAS å›ºä»¶æ›´æ–°
```

å›æ‰§ç¤ºä¾‹ï¼š

```
å·²åˆ›å»º 5 é¡¹ï¼š
â€¢ æ˜å¤© ä¹°èœ  â†’  2025-11-09
â€¢ å‘¨äº” ä¸‹åˆ 3 ç‚¹å¼€ä¼š  â†’  2025-11-14
â€¢ +2d è·‘ RAID æ ¡éªŒ  â†’  2025-11-10
â€¢ ä¸‹å‘¨ä¸€ å®¢æˆ·å›è®¿  â†’  2025-11-10
â€¢ 11-15 NAS å›ºä»¶æ›´æ–°  â†’  2025-11-15
```

## æ•°æ®å¤‡ä»½

### æ‰‹åŠ¨å¤‡ä»½

```bash
# å¤‡ä»½æ•°æ®åº“
cp data/bot.db data/bot.db.backup.$(date +%Y%m%d)

# æˆ–ä½¿ç”¨ tar æ‰“åŒ…
tar -czf backup-$(date +%Y%m%d).tar.gz data/
```

### è‡ªåŠ¨å¤‡ä»½ï¼ˆæ¨èï¼‰

åœ¨ NAS ä¸Šè®¾ç½®å®šæ—¶ä»»åŠ¡ï¼š

```bash
# æ¯å¤©å‡Œæ™¨ 2 ç‚¹å¤‡ä»½ï¼Œä¿ç•™ 30 å¤©
0 2 * * * /path/to/backup.sh
```

`backup.sh` ç¤ºä¾‹ï¼š

```bash
#!/bin/bash
BACKUP_DIR="/path/to/backups"
DATA_DIR="/path/to/Telegram_Plan_bot/data"

# åˆ›å»ºå¤‡ä»½
tar -czf "$BACKUP_DIR/planbot-$(date +\%Y\%m\%d).tar.gz" -C "$DATA_DIR" .

# åˆ é™¤ 30 å¤©å‰çš„å¤‡ä»½
find "$BACKUP_DIR" -name "planbot-*.tar.gz" -mtime +30 -delete
```

## æ•…éšœæ’æŸ¥

### 1. Bot æ— å“åº”

```bash
# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f

# æˆ–
docker logs -f telegram-planbot
```

### 2. æ—¶åŒºä¸æ­£ç¡®

æ£€æŸ¥é…ç½®æ–‡ä»¶ä¸­çš„ `timezone` è®¾ç½®ï¼š

```json
{
  "defaults": {
    "timezone": "Asia/Shanghai"  // ä½¿ç”¨ IANA æ—¶åŒºåç§°
  }
}
```

å¸¸è§æ—¶åŒºï¼š
- åŒ—äº¬æ—¶é—´ï¼š`Asia/Shanghai`
- ä¸œäº¬æ—¶é—´ï¼š`Asia/Tokyo`
- çº½çº¦æ—¶é—´ï¼š`America/New_York`
- ä¼¦æ•¦æ—¶é—´ï¼š`Europe/London`

### 3. æ•°æ®åº“æŸå

```bash
# åœæ­¢å®¹å™¨
docker-compose down

# æ¢å¤å¤‡ä»½
cp data/bot.db.backup.YYYYMMDD data/bot.db

# é‡å¯
docker-compose up -d
```

### 4. è°ƒåº¦ä»»åŠ¡æœªè§¦å‘

æ£€æŸ¥è°ƒåº¦å™¨æ˜¯å¦å¯åŠ¨ï¼š

```bash
# æŸ¥çœ‹æ—¥å¿—ä¸­æ˜¯å¦æœ‰ "Scheduler ready"
docker-compose logs | grep "Scheduler ready"
```

## å¼€å‘ä¸æµ‹è¯•

### è¿è¡Œå•å…ƒæµ‹è¯•

```bash
# æµ‹è¯•æ—¥æœŸè§£æå™¨
python -m unittest tests.test_date_parser -v

# æµ‹è¯•æ‰€æœ‰æ¨¡å—ï¼ˆå¾…å®ç°æ›´å¤šæµ‹è¯•ï¼‰
python -m unittest discover -s tests -v
```

### è°ƒè¯•æ¨¡å¼

ä¿®æ”¹ `config.json` ä¸­çš„æ—¥å¿—çº§åˆ«ï¼š

```json
{
  "logging": {
    "level": "DEBUG"  // è¾“å‡ºè¯¦ç»†æ—¥å¿—
  }
}
```

## æŠ€æœ¯æ¶æ„

### æŠ€æœ¯æ ˆ

- **Python 3.11+**
- **python-telegram-bot 20.7**ï¼šTelegram Bot API
- **SQLAlchemy 2.0**ï¼šORM å’Œæ•°æ®åº“ç®¡ç†
- **APScheduler 3.10**ï¼šå®šæ—¶ä»»åŠ¡è°ƒåº¦
- **pytz**ï¼šæ—¶åŒºå¤„ç†

### ç›®å½•ç»“æ„

```
Telegram_Plan_bot/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ bot/              # Bot äº¤äº’å±‚
â”‚   â”‚   â”œâ”€â”€ handlers.py   # å‘½ä»¤å¤„ç†å™¨
â”‚   â”‚   â”œâ”€â”€ callbacks.py  # å›è°ƒå¤„ç†å™¨
â”‚   â”‚   â””â”€â”€ messages.py   # æ¶ˆæ¯æ–‡æ¡ˆæ¨¡æ¿
â”‚   â”œâ”€â”€ core/             # æ ¸å¿ƒé€»è¾‘
â”‚   â”‚   â”œâ”€â”€ date_parser.py    # æ—¥æœŸè§£æå¼•æ“
â”‚   â”‚   â”œâ”€â”€ state_machine.py  # ä»»åŠ¡çŠ¶æ€æœº
â”‚   â”‚   â””â”€â”€ scheduler.py      # å®šæ—¶è°ƒåº¦ç³»ç»Ÿ
â”‚   â”œâ”€â”€ db/               # æ•°æ®å±‚
â”‚   â”‚   â”œâ”€â”€ models.py     # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ database.py   # æ•°æ®åº“æ“ä½œ
â”‚   â”‚   â””â”€â”€ init_db.py    # æ•°æ®åº“åˆå§‹åŒ–
â”‚   â”œâ”€â”€ utils/            # å·¥å…·æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ config.py     # é…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ logger.py     # æ—¥å¿—ç³»ç»Ÿ
â”‚   â”‚   â””â”€â”€ validators.py # éªŒè¯å™¨
â”‚   â””â”€â”€ constants.py      # å¸¸é‡å®šä¹‰
â”œâ”€â”€ tests/                # æµ‹è¯•
â”‚   â””â”€â”€ test_date_parser.py
â”œâ”€â”€ docs/                 # æ–‡æ¡£
â”‚   â””â”€â”€ planbot-checklist.v1.0.md
â”œâ”€â”€ main.py               # ä¸»ç¨‹åºå…¥å£
â”œâ”€â”€ requirements.txt      # Python ä¾èµ–
â”œâ”€â”€ Dockerfile            # Docker é•œåƒ
â”œâ”€â”€ docker-compose.yml    # Docker Compose é…ç½®
â”œâ”€â”€ config.example.json   # é…ç½®ç¤ºä¾‹
â””â”€â”€ README.md             # é¡¹ç›®æ–‡æ¡£
```

## è®¸å¯è¯

MIT License

## è‡´è°¢

æœ¬é¡¹ç›®ä¸¥æ ¼æŒ‰ç…§ `docs/planbot-checklist.v1.0.md` å¼€å‘æ¸…å•å®ç°ï¼Œæ„Ÿè°¢åŸä½œè€…çš„è¯¦ç»†è§„èŒƒã€‚
